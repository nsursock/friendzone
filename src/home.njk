{% set title = 'Home' %}
{% extends "layouts/inside.njk" %}

{% block body %}
  <!--
  This example requires some changes to your config:
  
  ```
  // tailwind.config.js
  const colors = require('tailwindcss/colors')
  
  module.exports = {
    // ...
    theme: {
      extend: {
        colors: {
          indigo: colors.indigo,
        },
      },
    },
    plugins: [
      // ...
      require('@tailwindcss/forms'),
    ],
  }
  ```
-->
  <!--
  This example requires updating your template:

  ```
  <html class="h-full bg-gray-100">
  <body class="h-full">
  ```
-->
  <div class="min-h-screen mt-px bg-gray-50"
    x-data="{ openActivity: false, openProfile: false, clicked: null, innerTab: 'Most Recent', tab: new URLSearchParams(location.search).get('tab') || 'Home' }">
    <div class="py-10">
      <div class="mx-auto max-w-3xl sm:px-6 lg:grid lg:max-w-7xl lg:grid-cols-12 lg:gap-8 lg:px-8">
        <div class="hidden lg:col-span-3 lg:block xl:col-span-2">
          <nav aria-label="Sidebar" class="sticky top-4 divide-y divide-gray-300">
            <div class="space-y-1 pb-8">
              <!-- Current: "bg-gray-200 text-gray-900", Default: "text-gray-700 hover:bg-gray-50" -->
              <button @click="tab = 'Home'; innerTab = 'Most Recent'" :class="tab === 'Home' ? 'bg-gray-200 text-gray-900' : 'text-gray-700 hover:bg-gray-50'" class="w-full group flex items-center px-3 py-2 text-sm font-medium rounded-md" aria-current="page">
                <!-- Heroicon name: outline/home -->
                <svg class="text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
                </svg>
                <span class="truncate">Home</span>
              </button>

              <button @click="tab = 'Popular'; innerTab = 'Most Recent'" :class="tab === 'Popular' ? 'bg-gray-200 text-gray-900' : 'text-gray-700 hover:bg-gray-50'" class="w-full group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                <!-- Heroicon name: outline/fire -->
                <svg class="text-gray-400 group-hover:text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z"/>
                </svg>
                <span class="truncate">Popular</span>
              </button>

              {# <a href="#" class="text-gray-700 hover:bg-gray-50 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                <!-- Heroicon name: outline/user-group -->
                <svg class="text-gray-400 group-hover:text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
                </svg>
                <span class="truncate">Communities</span>
              </a> #}

              <button @click="tab = 'Trending'; innerTab = 'Most Recent'" :class="tab === 'Trending' ? 'bg-gray-200 text-gray-900' : 'text-gray-700 hover:bg-gray-50'" class="w-full group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                <!-- Heroicon name: outline/arrow-trending-up -->
                <svg class="text-gray-400 group-hover:text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941"/>
                </svg>
                <span class="truncate">Trending</span>
              </button>

              <button @click="tab = 'Favorites'; innerTab = 'Most Recent'" :class="tab === 'Favorites' ? 'bg-gray-200 text-gray-900' : 'text-gray-700 hover:bg-gray-50'" class="w-full group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                <svg class="text-gray-400 group-hover:text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"/>
                </svg>
                <span class="truncate">Favorites</span>
              </button>
            </div>
            {# <div class="pt-10">
              <p class="px-3 text-sm font-medium text-gray-500" id="communities-headline">Communities</p>
              <div class="mt-3 space-y-2" aria-labelledby="communities-headline">
                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Movies</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Food</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Sports</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Animals</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Science</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Dinosaurs</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Talents</span>
                </a>

                <a href="#" class="group flex items-center rounded-md px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                  <span class="truncate">Gaming</span>
                </a>
              </div>
            </div> #}
          </nav>
        </div>
        <template x-if="$store.auth.user">
          <main :class="isFetching && 'blur animate-pulse'" class="lg:col-span-9 xl:col-span-6" x-data="dataFeed()"
            x-init="isFetching = true; refreshFeed(); isFetching = false"
            x-effect="refreshFeed()">
            {% include 'write.njk' %}

            <div class="px-4 sm:px-0">
              {# <button @click="openNewPost = !openNewPost" class="md:hidden mb-2 block w-full rounded-md border border-indigo-300 bg-indigo-600 px-4 py-2 text-center text-sm font-medium text-indigo-100 shadow-sm hover:bg-indigo-700">New Post</button> #}

              <div class="sm:hidden">
                <label for="question-tabs" class="sr-only">Select a tab</label>
                <select @change="innerTab = event.target.value; 
                  if (innerTab.includes('Recent')) posts = posts.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
                  else if (innerTab.includes('Liked')) posts = posts.sort((a, b) => { 
                      if (b.num_like - a.num_like === 0) return new Date(b.created_at).getTime() - new Date(a.created_at).getTime() 
                      else return b.num_like - a.num_like })
                  else if (innerTab.includes('Comments')) posts = posts.sort((a, b) => { 
                      if (b.num_ans - a.num_ans === 0) return new Date(b.created_at).getTime() - new Date(a.created_at).getTime() 
                      else return b.num_ans - a.num_ans })"
                  id="question-tabs" class="block w-full rounded-md border-gray-300 text-base font-medium text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  <option selected>Most Recent</option>

                  <option>Most Liked</option>

                  <option>Most Comments</option>
                </select>
              </div>
              <div class="hidden sm:block">
                <nav class="isolate flex divide-x divide-gray-200 rounded-lg shadow" aria-label="Tabs">
                  <!-- Current: "text-gray-900", Default: "text-gray-500 hover:text-gray-700" -->
                  <button @click="page = 1; innerTab = 'Most Recent'; posts = posts.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())" 
                    aria-current="page" :class="innerTab === 'Most Recent' ? 'text-gray-900' : 'text-gray-500 hover:text-gray-700'" 
                    class="rounded-l-lg group relative min-w-0 flex-1 overflow-hidden bg-white py-4 px-6 text-sm font-medium text-center hover:bg-gray-50 focus:z-10">
                    <span>Most Recent</span>
                    <span aria-hidden="true" :class="innerTab === 'Most Recent' ? 'bg-indigo-500' : 'bg-transparent'" class="absolute inset-x-0 bottom-0 h-0.5"></span>
                  </button>

                  <button @click="page = 1; innerTab = 'Most Liked'; posts = posts.sort((a, b) => { 
                      if (b.num_like - a.num_like === 0) return new Date(b.created_at).getTime() - new Date(a.created_at).getTime() 
                      else return b.num_like - a.num_like })"
                    :class="innerTab === 'Most Liked' ? 'text-gray-900' : 'text-gray-500 hover:text-gray-700'" 
                    class="group relative min-w-0 flex-1 overflow-hidden bg-white py-4 px-6 text-sm font-medium text-center hover:bg-gray-50 focus:z-10">
                    <span>Most Liked</span>
                    <span aria-hidden="true" :class="innerTab === 'Most Liked' ? 'bg-indigo-500' : 'bg-transparent'" class="absolute inset-x-0 bottom-0 h-0.5"></span>
                  </button>

                  <button @click="page = 1; innerTab = 'Most Comments'; posts = posts.sort((a, b) => { 
                      if (b.num_ans - a.num_ans === 0) return new Date(b.created_at).getTime() - new Date(a.created_at).getTime() 
                      else return b.num_ans - a.num_ans })"
                    :class="innerTab === 'Most Comments' ? 'text-gray-900' : 'text-gray-500 hover:text-gray-700'" 
                    class="rounded-r-lg group relative min-w-0 flex-1 overflow-hidden bg-white py-4 px-6 text-sm font-medium text-center hover:bg-gray-50 focus:z-10">
                    <span>Most Comments</span>
                    <span aria-hidden="true" :class="innerTab === 'Most Comments' ? 'bg-indigo-500' : 'bg-transparent'" class="absolute inset-x-0 bottom-0 h-0.5"></span>
                  </button>
                </nav>
              </div>
            </div>

            <div class="mt-4" x-data="{ page: 1, size: 10 }">

              <h1 class="sr-only">Recent questions</h1>
              <ul role="list" class="space-y-4">
                <template x-for="post in filteredPosts().slice(0, page * size)" :key="post.id">
                  <li class="bg-white px-4 py-6 shadow sm:rounded-lg sm:p-6" x-data="{ shared: null, comments: [], openCommentSection: false }"
                    x-init="getShared(post)"
                    x-intersect.once="!isFetching && await fetch(`/api/content?mode=increment&field=impr&id=${post.id}`)">
                    <article :aria-labelledby="`post-id-${post.id}`">
                      <div>
                        <div class="flex justify-between">
                          <div class="flex">
                            <template x-if="!post.author.avatar_url">
                              <span class="h-10 w-10 overflow-hidden rounded-full bg-gray-100">
                                <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                              </span>
                            </template>
                            <template x-if="post.author.avatar_url">
                              <div class="flex-shrink-0">
                                <img x-intersect.once="$el.src = $el.dataset.src" class="h-10 w-10 rounded-full" :data-src="post.author.avatar_url.includes('unsplash') ? post.author.avatar_url+'&fit=facearea&facepad=2&w=256&h=256&q=80' : post.author.avatar_url" alt="">
                              </div>
                            </template>
                            <div class="min-w-0 flex-1 ml-3">
                              <p class="text-sm font-medium text-gray-900">
                                <button @click="clicked = post.author; openProfile = !openProfile" class="hover:underline" x-text="post.author.first_name + ' ' + post.author.last_name"></button>
                              </p>
                              <p class="text-sm text-gray-500">
                                <span class="">
                                  <span x-text="formatDate(new Date(post.created_at), 'MMMM d') + ' at ' + formatDate(new Date(post.created_at), 'hh:mm aa')"></span>
                                </span>
                              </p>
                            </div>
                          </div>
                          <div class="flex flex-shrink-0 self-center" x-data="{ open: false }">
                            <div class="relative inline-block text-left">
                              <div>
                                <button @click="open = !open" type="button" class="-m-2 flex items-center rounded-full p-2 text-gray-400 hover:text-gray-600" id="options-menu-0-button" aria-expanded="false" aria-haspopup="true">
                                  <span class="sr-only">Open options</span>
                                  <!-- Heroicon name: mini/ellipsis-vertical -->
                                  <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z"/>
                                  </svg>
                                </button>
                              </div>

                              <!--
                          Dropdown menu, show/hide based on menu state.

                          Entering: "transition ease-out duration-100"
                            From: "transform opacity-0 scale-95"
                            To: "transform opacity-100 scale-100"
                          Leaving: "transition ease-in duration-75"
                            From: "transform opacity-100 scale-100"
                            To: "transform opacity-0 scale-95"
                        -->
                              <div @click.outside="open = !open" x-show="open" 
                            class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="options-menu-0-button" tabindex="-1">
                                <div class="py-1" role="none">
                                  <!-- Active: "bg-gray-100 text-gray-900", Not Active: "text-gray-700" -->
                                  <button @click="open = !open; openNewPost = !openNewPost; postId = post.id" class="w-full hover:bg-gray-100 text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-2">
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                      <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Comment</span>
                                  </button>
                                  <button @click="open = !open; await (await fetch(`/api/content?mode=bookmark&id=${post.id}&email=${$store.auth.user.email}`))" class="w-full hover:bg-gray-100 text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-0">
                                    <!-- Heroicon name: mini/star -->
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Bookmark</span>
                                  </button>
                                  <button x-show="post.author.email === $store.auth.user?.email" @click="open = !open; await (await fetch(`/api/content?mode=delete&level=zero&id=${post.id}`)); refreshFeed()" class="w-full hover:bg-gray-100 text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-1">
                                    <!-- Heroicon name: mini/trash -->
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                      <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Delete</span>
                                  </button>
                                  <a href="#" class="w-full hover:bg-gray-100 text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-2">
                                    <!-- Heroicon name: mini/flag -->
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.449 6.449 0 014.271.572 7.948 7.948 0 005.965.524l2.078-.64A.75.75 0 0018 12.25v-8.5a.75.75 0 00-.904-.734l-2.38.501a7.25 7.25 0 01-4.186-.363l-.502-.2a8.75 8.75 0 00-5.053-.439l-1.475.31V2.75z"/>
                                    </svg>
                                    <span>Report</span>
                                  </a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        {# <h2 id="question-title-81614" class="mt-4 text-base font-medium text-gray-900">What would you have done differently if you ran Jurassic Park?</h2> #}
                      </div>
                      <template x-if="shared">

                        <article class="bg-gray-50 mt-3 px-4 py-6 shadow sm:rounded-lg sm:p-6" :aria-labelledby="`post-id-${post.id}`">
                          <div>
                            <div class="flex justify-between">
                              <div class="flex">
                                <template x-if="!shared.author.avatar_url">
                                  <span class="h-10 w-10 overflow-hidden rounded-full bg-gray-100">
                                    <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                      <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                  </span>
                                </template>
                                <template x-if="shared.author.avatar_url">
                                  <div class="flex-shrink-0">
                                    <img x-intersect.once="$el.src = $el.dataset.src" class="h-10 w-10 rounded-full" :data-src="shared.author.avatar_url.includes('unsplash') ? shared.author.avatar_url+'&fit=facearea&facepad=2&w=256&h=256&q=80' : shared.author.avatar_url" alt="">
                                  </div>
                                </template>
                                <div class="min-w-0 flex-1 ml-3">
                                  <p class="text-sm font-medium text-gray-900">
                                    <button @click="clicked = shared.author; openProfile = !openProfile" class="hover:underline" x-text="shared.author.first_name + ' ' + shared.author.last_name"></button>
                                  </p>
                                  <p class="text-sm text-gray-500">
                                    <span class="">
                                      <span x-text="formatDate(new Date(shared.created_at), 'MMMM d') + ' at ' + formatDate(new Date(shared.created_at), 'hh:mm aa')"></span>
                                    </span>
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div x-html="marked.parse(shared.content)" :class="/[\u0600-\u06FF]/.test(shared.content) && 'text-right'" class="prose mt-2 space-y-4 text-sm text-gray-700"></div>
                        </article>

                      </template>
                      <template x-if="!shared">
                        <div x-data="{ content: null }" x-effect="if (post.content) content = marked.parse(post.content)" x-html="content" 
                        :class="/[\u0600-\u06FF]/.test(post.content) && 'text-right'"
                        class="prose mt-2 space-y-4 text-sm text-gray-700 prose-p:leading-snug"></div>
                      </template>
                      <div class="mt-6 flex justify-between space-x-8">
                        <div class="flex space-x-6">
                          <span class="inline-flex items-center text-sm" x-data="{ clicked: false }">
                            <button @click="clicked = true; await fetch(`/api/content?mode=increment&field=like&id=${post.id}`); clicked = false" type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                              <!-- Heroicon name: mini/hand-thumb-up -->
                              <svg :class="clicked && 'animate-ping'" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path d="M1 8.25a1.25 1.25 0 112.5 0v7.5a1.25 1.25 0 11-2.5 0v-7.5zM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0114 3c0 .995-.182 1.948-.514 2.826-.204.54.166 1.174.744 1.174h2.52c1.243 0 2.261 1.01 2.146 2.247a23.864 23.864 0 01-1.341 5.974C17.153 16.323 16.072 17 14.9 17h-3.192a3 3 0 01-1.341-.317l-2.734-1.366A3 3 0 006.292 15H5V8h.963c.685 0 1.258-.483 1.612-1.068a4.011 4.011 0 012.166-1.73c.432-.143.853-.386 1.011-.814.16-.432.248-.9.248-1.388z"/>
                              </svg>
                              <span class="font-medium text-gray-900" x-text="post.num_like ?? 0"></span>
                              <span class="sr-only">likes</span>
                            </button>
                          </span>
                          <span class="inline-flex items-center text-sm">
                            <button @click="comments = (await (await fetch(`/api/content?mode=comments&id=${post.id}`)).json()).data; openCommentSection = !openCommentSection" type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                              <!-- Heroicon name: mini/chat-bubble-left-ellipsis -->
                              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902.848.137 1.705.248 2.57.331v3.443a.75.75 0 001.28.53l3.58-3.579a.78.78 0 01.527-.224 41.202 41.202 0 005.183-.5c1.437-.232 2.43-1.49 2.43-2.903V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                              </svg>
                              <span class="font-medium text-gray-900" x-text="post.num_ans"></span>
                              <span class="sr-only">replies</span>
                            </button>
                          </span>
                          <span class="inline-flex items-center text-sm">
                            <button type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                              <!-- Heroicon name: mini/eye -->
                              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/>
                                <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.186A10.004 10.004 0 0110 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0110 17c-4.257 0-7.893-2.66-9.336-6.41zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                              </svg>
                              <span class="font-medium text-gray-900" x-text="post.num_impr ?? 0"></span>
                              <span class="sr-only">views</span>
                            </button>
                          </span>
                        </div>
                        <div class="flex text-sm">
                          <template x-if="!shared">
                            <span class="inline-flex items-center text-sm">
                              <button @click="postId = post.id; handleShare()" type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                                <!-- Heroicon name: mini/share -->
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                  <path d="M13 4.5a2.5 2.5 0 11.702 1.737L6.97 9.604a2.518 2.518 0 010 .792l6.733 3.367a2.5 2.5 0 11-.671 1.341l-6.733-3.367a2.5 2.5 0 110-3.475l6.733-3.366A2.52 2.52 0 0113 4.5z"/>
                                </svg>
                                <span class="font-medium text-gray-900">Share</span>
                              </button>
                            </span>
                          </template>
                        </div>
                      </div>
                    </article>

                    <!--
  This example requires some changes to your config:
  
  ```
  // tailwind.config.js
  const colors = require('tailwindcss/colors')
  
  module.exports = {
    // ...
    theme: {
      extend: {
        colors: {
          rose: colors.rose,
        },
      },
    },
  }
  ```
-->
                    <div class="flow-root mt-8" x-show="comments.length > 0 && openCommentSection">
                      <ul role="list" class="-mb-8">
                        <template x-for="(comment, index) in comments.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())" :key="comment.id">
                          <li :aria-labelledby="`comment-id-${comment.id}`" x-intersect.once="await fetch(`/api/content?mode=increment&field=impr&id=${comment.id}`)">
                            <div class="relative pb-8">
                              <span x-show="index + 1 < comments.length" class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                              <div class="relative flex items-start">
                                <template x-if="!comment.author.avatar_url">
                                  <span class="h-10 w-10 overflow-hidden rounded-full bg-gray-100 mr-3">
                                    <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                      <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                  </span>
                                </template>
                                <div class="relative">
                                  <template x-if="comment.author.avatar_url">
                                    <img x-intersect.once="$el.src = $el.dataset.src" class="mr-3 flex h-10 w-10 items-center justify-center rounded-full bg-gray-400 ring-8 ring-white" :data-src="comment.author.avatar_url.includes('unsplash') ? comment.author.avatar_url+'&fit=facearea&facepad=8&w=256&h=256&q=80' : comment.author.avatar_url" alt="">
                                  </template>
                                  {# <span class="absolute -bottom-0.5 -right-1 rounded-tl bg-white px-0.5 py-px">
                                    <!-- Heroicon name: mini/chat-bubble-left-ellipsis -->
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902.848.137 1.705.248 2.57.331v3.443a.75.75 0 001.28.53l3.58-3.579a.78.78 0 01.527-.224 41.202 41.202 0 005.183-.5c1.437-.232 2.43-1.49 2.43-2.903V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                    </svg>
                                  </span> #}
                                </div>
                                <div class="min-w-0 flex-1">
                                  <div class="flex justify-between">
                                    <div>
                                      <div class="text-sm">
                                        <button @click="clicked = comment.author; openProfile = !openProfile" class="font-medium text-gray-900 hover:underline" x-text="comment.author.first_name + ' ' + comment.author.last_name"></button>
                                      </div>
                                      <p class="mt-0.5 text-sm text-gray-500" x-text="`Commented ${formatDate(new Date(comment.created_at), 'distance')}`"></p>
                                    </div>

                                    <div class="flex flex-shrink-0 self-center" x-data="{ open: false }">
                                      <div class="relative inline-block text-left">
                                        <div>
                                          <button @click="open = !open" type="button" class="-m-2 flex items-center rounded-full p-2 text-gray-400 hover:text-gray-600" id="options-menu-0-button" aria-expanded="false" aria-haspopup="true">
                                            <span class="sr-only">Open options</span>
                                            <!-- Heroicon name: mini/ellipsis-vertical -->
                                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                              <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z"/>
                                            </svg>
                                          </button>
                                        </div>

                                        <!--
                          Dropdown menu, show/hide based on menu state.

                          Entering: "transition ease-out duration-100"
                            From: "transform opacity-0 scale-95"
                            To: "transform opacity-100 scale-100"
                          Leaving: "transition ease-in duration-75"
                            From: "transform opacity-100 scale-100"
                            To: "transform opacity-0 scale-95"
                        -->
                                        <div @click.outside="open = !open" x-show="open" 
                            class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="options-menu-0-button" tabindex="-1">
                                          <div class="py-1" role="none">
                                            <!-- Active: "bg-gray-100 text-gray-900", Not Active: "text-gray-700" -->
                                            <button @click="open = !open; openNewPost = !openNewPost; postId = comment.id" class="text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-2">
                                              <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                                <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" clip-rule="evenodd"/>
                                              </svg>
                                              <span>Comment</span>
                                            </button>
                                            <button x-show="comment.author.email === $store.auth.user?.email" @click="open = !open; await (await fetch(`/api/content?mode=delete&level=one&id=${comment.id}`)); refreshFeed()" class="text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-1">
                                              <!-- Heroicon name: mini/trash -->
                                              <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd"/>
                                              </svg>
                                              <span>Delete</span>
                                            </button>
                                            {# <button @click="open = !open; await (await fetch(`/api/content?mode=bookmark&id=${post.id}&email=${$store.auth.user.email}`))" class="text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-0">
                                    <!-- Heroicon name: mini/star -->
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Bookmark</span>
                                  </button>
                                  <a href="#" class="text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-1">
                                    <!-- Heroicon name: mini/code-bracket -->
                                    <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M6.28 5.22a.75.75 0 010 1.06L2.56 10l3.72 3.72a.75.75 0 01-1.06 1.06L.97 10.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0zm7.44 0a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L17.44 10l-3.72-3.72a.75.75 0 010-1.06zM11.377 2.011a.75.75 0 01.612.867l-2.5 14.5a.75.75 0 01-1.478-.255l2.5-14.5a.75.75 0 01.866-.612z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Embed</span>
                                  </a> #}
                                            <a href="#" class="text-gray-700 flex px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="options-menu-0-item-2">
                                              <!-- Heroicon name: mini/flag -->
                                              <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                <path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.449 6.449 0 014.271.572 7.948 7.948 0 005.965.524l2.078-.64A.75.75 0 0018 12.25v-8.5a.75.75 0 00-.904-.734l-2.38.501a7.25 7.25 0 01-4.186-.363l-.502-.2a8.75 8.75 0 00-5.053-.439l-1.475.31V2.75z"/>
                                              </svg>
                                              <span>Report</span>
                                            </a>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="mt-2 text-sm text-gray-700" :class="/[\u0600-\u06FF]/.test(comment.content) && 'text-right'">
                                    <p class="prose prose-sm prose-p:leading-snug" x-html="marked.parse(comment.content)"></p>
                                  </div>

                                  <div class="flex space-x-6 mt-2">
                                    <span class="inline-flex items-center text-sm" x-data="{ clicked: false }">
                                      <button @click="clicked = true; await fetch(`/api/content?mode=increment&field=like&id=${comment.id}`); clicked = false" type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                                        <!-- Heroicon name: mini/hand-thumb-up -->
                                        <svg :class="clicked && 'animate-ping'" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                          <path d="M1 8.25a1.25 1.25 0 112.5 0v7.5a1.25 1.25 0 11-2.5 0v-7.5zM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0114 3c0 .995-.182 1.948-.514 2.826-.204.54.166 1.174.744 1.174h2.52c1.243 0 2.261 1.01 2.146 2.247a23.864 23.864 0 01-1.341 5.974C17.153 16.323 16.072 17 14.9 17h-3.192a3 3 0 01-1.341-.317l-2.734-1.366A3 3 0 006.292 15H5V8h.963c.685 0 1.258-.483 1.612-1.068a4.011 4.011 0 012.166-1.73c.432-.143.853-.386 1.011-.814.16-.432.248-.9.248-1.388z"/>
                                        </svg>
                                        <span class="font-medium text-gray-900" x-text="comment.num_like ?? 0"></span>
                                        <span class="sr-only">likes</span>
                                      </button>
                                    </span>
                                    {# <span class="inline-flex items-center text-sm">
                                    <button @click="openCommentSection = !openCommentSection" type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                                      <!-- Heroicon name: mini/chat-bubble-left-ellipsis -->
                                      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902.848.137 1.705.248 2.57.331v3.443a.75.75 0 001.28.53l3.58-3.579a.78.78 0 01.527-.224 41.202 41.202 0 005.183-.5c1.437-.232 2.43-1.49 2.43-2.903V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                      </svg>
                                      <span class="font-medium text-gray-900" x-text="post.num_ans"></span>
                                      <span class="sr-only">replies</span>
                                    </button>
                                  </span> #}
                                    <span class="inline-flex items-center text-sm">
                                      <button type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                                        <!-- Heroicon name: mini/eye -->
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                          <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/>
                                          <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.186A10.004 10.004 0 0110 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0110 17c-4.257 0-7.893-2.66-9.336-6.41zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="font-medium text-gray-900" x-text="comment.num_impr ?? 0"></span>
                                        <span class="sr-only">views</span>
                                      </button>
                                    </span>
                                  </div>

                                  {% include 'comments.njk' %}
                                </div>
                              </div>
                            </div>
                          </li>
                        </template>
                      </ul>
                    </div>

                  </li>
                </template>

                <!-- More questions... -->
              </ul>
              <div class="" x-intersect="page++"></div>
            </div>

          </main>
        </template>
        <template x-if="$store.auth.user">
          <aside class="hidden xl:col-span-4 xl:block" :class="isFetching && 'blur animate-pulse'" x-data="{ isFetching: false }">
            <div class="sticky top-4 space-y-4">
              {# <div class="flex"> #}
              {# <button @click="openNewPost = !openNewPost" class="block w-full rounded-md border border-indigo-300 bg-indigo-600 px-4 py-2 text-center text-sm font-medium text-indigo-100 shadow-sm hover:bg-indigo-700">New Post</button> #}
              {# <button @click="open = !open" class="ml-2 block w-full rounded-md border border-gray-300 bg-white px-4 py-2 text-center text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">View Activity</button> #}
              {# <div class="ml-2 ">
                  <label for="day" class="block text-sm font-medium text-gray-900">Day</label>
                  <input x-model="day" type="date" id="day" name="day" class="block w-full rounded-md border-gray-300 text-gray-900 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div> #}
              {# </div> #}
              <section aria-labelledby="who-to-follow-heading" x-data="{ people: [
                {
                  id: -1,
                  avatar_url: 'https://images.unsplash.com/photo-1519345182560-3f2917c472ef?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80',
                  first_name: 'Leonard',
                  last_name: 'Krasner'
                },
                {
                  id: -2,
                  avatar_url: 'https://images.unsplash.com/photo-1463453091185-61582044d556?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80',
                  first_name: 'Eddie',
                  last_name: 'Floyd'
                },
                {
                  id: -3,
                  avatar_url: 'https://images.unsplash.com/photo-1502685104226-ee32379fefbe?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80',
                  first_name: 'Maggie',
                  last_name: 'Liezner'
                }
              ], friends: [], refreshSuggestions: false }" 
              x-init="isFetching = true; people = (await(await fetch('/api/directory')).json()).data.filter(user => user.last_name !== null); isFetching = false"
              x-effect="friends = (await (await fetch(`/api/directory?mode=friends&minimum=pending&email=${$store.auth.user?.email}`)).json()).data">
                <div class="rounded-lg bg-white shadow">
                  <div class="p-6">
                    <h2 id="who-to-follow-heading" class="text-base font-medium text-gray-900">Suggestions</h2>
                    <div class="mt-6 flow-root">
                      <ul role="list" class="-my-4 divide-y divide-gray-200">
                        <template x-for="person in people.filter((p) => !friends.map((f) => f.email).concat($store.auth.user?.email).includes(p.email))
                            .sort(() => 0.5 - Math.random()).slice(0, 3)" :key="person.id">
                          <li class="flex items-center space-x-3 py-4">
                            <template x-if="!person.avatar_url">
                              <span class="h-8 w-8 overflow-hidden rounded-full bg-gray-100">
                                <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                              </span>
                            </template>
                            <template x-if="person.avatar_url">
                              <div class="flex-shrink-0">
                                <img class="h-8 w-8 rounded-full" :src="person.avatar_url.includes('unsplash') ? person.avatar_url+'&fit=facearea&facepad=2&w=256&h=256&q=80' : person.avatar_url" alt="">
                              </div>
                            </template>
                            <div class="min-w-0 flex-1">
                              <p class="text-sm font-medium text-gray-900">
                                <button class="hover:underline" @click="clicked = person; openProfile = !openProfile"  x-text="person.first_name + ' ' + person.last_name"></button>
                              </p>
                              <p class="text-sm text-gray-500">
                                <button class="hover:underline" @click="clicked = person; openProfile = !openProfile" x-text="`@${person.user_name}`"></button>
                              </p>
                            </div>
                            <div class="flex-shrink-0">
                              <button @click="handleConnect(person.email); 
                              const index = people.findIndex((p) => p.email === person.email); 
                              if (index > -1) people.splice(index, 1)" 
                            type="button" class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-0.5 text-sm font-medium text-indigo-700 hover:bg-indigo-100">
                                <!-- Heroicon name: mini/plus -->
                                <svg class="-ml-1 mr-0.5 h-5 w-5 text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                  <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/>
                                </svg>
                                <span>Connect</span>
                              </button>
                            </div>
                          </li>
                        </template>

                        <!-- More people... -->
                      </ul>
                    </div>
                    <div class="mt-6">
                      <button @click="tab = 'Popular'" class="block w-full rounded-md border border-gray-300 bg-white px-4 py-2 text-center text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">View all</a>
                    </div>
                  </div>
                </div>
              </section>
              <section aria-labelledby="trending-heading" x-data="{ trendingPosts: [
              { id: -1, author: { avatar_url: 'https://images.unsplash.com/photo-1519345182560-3f2917c472ef?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80' },
                content: 'Magnam unde eligendi provident dolorum occaecati id unde asperiores ea. Excepturi soluta quibusdam.', num_ans: 201 },
              { id: -2, author: { avatar_url: 'https://images.unsplash.com/photo-1463453091185-61582044d556?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80' },
                content: 'Deserunt ullam nulla consequuntur animi. Similique occaecati animi corporis cumque quas magnam illo ab officiis.', num_ans: 187 },
              { id: -3, author: { avatar_url: 'https://images.unsplash.com/photo-1502685104226-ee32379fefbe?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80' },
                content: 'Modi reiciendis incidunt fugiat eos ullam dicta. Nobis in laudantium pariatur saepe dolores voluptatem repellendus incidunt optio.', num_ans: 112 },
            ] }" 
              x-init="trendingPosts = (await(await fetch('/api/content?mode=trending')).json()).data">
                <div class="rounded-lg bg-white shadow">
                  <div class="p-6">
                    <h2 id="trending-heading" class="text-base font-medium text-gray-900">Trending</h2>
                    <div class="mt-6 flow-root">
                      <ul role="list" class="-my-4 divide-y divide-gray-200">
                        <template x-for="post in trendingPosts.slice(0, 3)" :key="post.id">
                          <li class="flex space-x-3 py-4">
                            <template x-if="!post.author.avatar_url">
                              <span class="h-8 w-8 overflow-hidden rounded-full bg-gray-100">
                                <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                              </span>
                            </template>
                            <template x-if="post.author.avatar_url">
                              <div class="flex-shrink-0">
                                <img class="h-8 w-8 rounded-full" :src="post.author.avatar_url.includes('unsplash') ? post.author.avatar_url+'&fit=facearea&facepad=2&w=256&h=256&q=80' : post.author.avatar_url" alt="Floyd Miles">
                              </div>
                            </template>
                            <div class="min-w-0 flex-1">
                              <p class="text-sm text-gray-800" x-text="post.content.length > 75 ? post.content.slice(0, 75) + '...' : post.content"></p>
                              <div class="mt-2 flex">
                                <span class="inline-flex items-center text-sm">
                                  <button type="button" class="inline-flex space-x-2 text-gray-400 hover:text-gray-500">
                                    <!-- Heroicon name: mini/chat-bubble-left-ellipsis -->
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902.848.137 1.705.248 2.57.331v3.443a.75.75 0 001.28.53l3.58-3.579a.78.78 0 01.527-.224 41.202 41.202 0 005.183-.5c1.437-.232 2.43-1.49 2.43-2.903V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="font-medium text-gray-900" x-text="post.num_ans"></span>
                                  </button>
                                </span>
                              </div>
                            </div>
                          </li>
                        </template>

                        <!-- More posts... -->
                      </ul>
                    </div>
                    <div class="mt-6">
                      <button @click="tab = 'Trending'" class="block w-full rounded-md border border-gray-300 bg-white px-4 py-2 text-center text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">View all</a>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </aside>
        </template>
      </div>
    </div>

    <div x-show="clicked">
      {% include 'profile.njk' %}
    </div>

    {# <div x-show="open" class="relative z-10" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
      <!--
    Background backdrop, show/hide based on slide-over state.

    Entering: "ease-in-out duration-500"
      From: "opacity-0"
      To: "opacity-100"
    Leaving: "ease-in-out duration-500"
      From: "opacity-100"
      To: "opacity-0"
  -->
      <div x-show="open" 
        x-transition:enter="ease-in-out duration-500"
        x-transition:enter-start="opacity-0 "
        x-transition:enter-end="opacity-100 "
        x-transition:leave="ease-in-out duration-500"
        x-transition:leave-start="opacity-100 "
        x-transition:leave-end="opacity-0 "
      class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

      <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 overflow-hidden">
          <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
            <!--
          Slide-over panel, show/hide based on slide-over state.

          Entering: "transform transition ease-in-out duration-500 sm:duration-700"
            From: "translate-x-full"
            To: "translate-x-0"
          Leaving: "transform transition ease-in-out duration-500 sm:duration-700"
            From: "translate-x-0"
            To: "translate-x-full"
        -->
            <div x-show="open" @click.outside="open = !open"
              x-transition:enter="transform transition ease-in-out duration-500 sm:duration-700"
              x-transition:enter-start="translate-x-full"
              x-transition:enter-end="translate-x-0"
              x-transition:leave="transform transition ease-in-out duration-500 sm:duration-700"
              x-transition:leave-start="translate-x-0"
              x-transition:leave-end="translate-x-full"
            class="pointer-events-auto w-screen max-w-md">
              <div class="flex h-full flex-col overflow-y-scroll bg-white shadow-xl">
                <div class="bg-indigo-700 py-6 px-4 sm:px-6">
                  <div class="flex items-center justify-between">
                    <h2 class="text-lg font-medium text-white" id="slide-over-title">Panel title</h2>
                    <div class="ml-3 flex h-7 items-center">
                      <button @click="open = !open" type="button" class="rounded-md bg-indigo-700 text-indigo-200 hover:text-white focus:outline-none focus:ring-2 focus:ring-white">
                        <span class="sr-only">Close panel</span>
                        <!-- Heroicon name: outline/x-mark -->
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="mt-1">
                    <p class="text-sm text-indigo-300">Lorem, ipsum dolor sit amet consectetur adipisicing elit aliquam ad hic recusandae soluta.</p>
                  </div>
                </div>
                <div class="relative flex-1 py-6 px-4 sm:px-6">
                  <!-- Replace with your content -->
              <div class="absolute inset-0 py-6 px-4 sm:px-6">
                <div class="h-full border-2 border-dashed border-gray-200" aria-hidden="true"></div>
              </div>
              <!-- /End replace -->

                  <!-- Activity feed -->
<!--                  <div class="bg-gray-50 pr-4 sm:pr-6 lg:flex-shrink-0 lg:border-l lg:border-gray-200 lg:pr-8 xl:pr-0"> -->
                  <div class="px-6">
                    <div class="pt-6 pb-2">
                      <h2 class="text-sm font-semibold">Activity</h2>
                    </div>
                    <div>
                      <ul role="list" class="divide-y divide-gray-200">
                        <li class="py-4">
                          <div class="flex space-x-3">
                            <img class="h-6 w-6 rounded-full" src="https://images.unsplash.com/photo-1517365830460-955ce3ccd263?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=256&h=256&q=80" alt="">
                            <div class="flex-1 space-y-1">
                              <div class="flex items-center justify-between">
                                <h3 class="text-sm font-medium">You</h3>
                                <p class="text-sm text-gray-500">1h</p>
                              </div>
                              <p class="text-sm text-gray-500">Deployed Workcation (2d89f0c8 in master) to production</p>
                            </div>
                          </div>
                        </li>

                        <!-- More items... -->
                      </ul>
                      <div class="border-t border-gray-200 py-4 text-sm">
                        <a href="#" class="font-semibold text-indigo-600 hover:text-indigo-900">
              View all activity
              <span aria-hidden="true"> &rarr;</span>
                        </a>
                      </div>
                    </div>
                  </div>
<!--                  </div> -->

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> #}

  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    function dataFeed() {
      return {
        postId: null,
        //        day: new Date(),

        originals: [],
        posts: [
          {
            id: -1,
            created_at: new Date(),
            skeleton: true,
            author: {
              avatar_url: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?ixid=MnwzOTk4NzJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NzQwNTgxNzA&ixlib=rb-4.0.3'
            },
            content: 'Jurassic Park was an incredible idea and a magnificent feat of engineering, but poor protocols and a disregard for human safety killed what could have otherwise been one of the best businesses of our generation.'
          }, {
            id: -2,
            created_at: new Date(),
            skeleton: true,
            author: {
              avatar_url: 'https://images.unsplash.com/photo-1483818993731-3d76e0c51133?ixid=MnwzOTk4NzJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NzQwNTA1NDM&ixlib=rb-4.0.3'
            },
            content: 'Man I am glad you asked this question. I\'m a 6 year old golden retriever and while I still have a few years left to experience, I think I\'ve been around long enough to tell you what it\'s really like.'
          }, {
            id: -3,
            created_at: new Date(),
            skeleton: true,
            author: {
              avatar_url: 'https://images.unsplash.com/photo-1468488718849-422a2a5efc03?ixid=MnwzOTk4NzJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NzQwNTA1Mzg&ixlib=rb-4.0.3'
            },
            content: 'This is something most people wonder about themselves at least 4 or 5 times throughout their life. Everyone ignores you for weeks on end (including your immediate family) and the only person who will talk to you is a little boy you are treating because he thinks he sees dead people.'
          }
        ],
        isFetching: false,

        filteredPosts() {
          return this
            .posts
            .filter(
              (post) => post.content
              ?.toLowerCase().includes(this.searchText.toLowerCase()) || this.originals?.find((original) => post.share_id === original.id)
                ?.content
                  ?.toLowerCase().includes(this.searchText.toLowerCase()))
        },

        async refreshFeed() {
          this.isFetching = true;
          //console.log(this.day)

          if (this.tab === 'Trending') {
            const {data: posts, originals: orig} = (await(await fetch('/api/content?mode=trending')).json())
            this.originals = orig;
            this.posts = posts
              .sort((a, b) => {
                if (b.num_ans - a.num_ans === 0) 
                  return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
                else 
                  return b.num_ans - a.num_ans
              })
          } else if (this.tab === 'Popular') {
            const {data: posts, originals: orig} = (await(await fetch('/api/content?mode=trending')).json())
            this.originals = orig;
            this.posts = posts
              .sort((a, b) => {
                if (b.num_like - a.num_like === 0) 
                  return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
                else 
                  return b.num_like - a.num_like
              })
          } else if (this.tab === 'Favorites') {
            const {data: posts, originals: orig} = (await(await fetch(
              `/api/content?mode=favorites&email=${Alpine.store('auth').user
              ?.email}`)).json())
            this.originals = orig;
            this.posts = !posts
              ? []
              : posts.sort((a, b) => {
                return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
              })
          } else {
            const {data: posts, originals: orig} = (await(await fetch(
              `/api/content?mode=display&email=${Alpine.store('auth').user
              ?.email}`)).json())
            this.originals = orig;
            this.posts = posts
          }

          this.isFetching = false
        },

        async getShared(post) {
          if (post.share_id) 
            this.shared = (await(await fetch(`/api/content?mode=shared&id=${post.share_id}`)).json()).data
        },

        handleShare() {
          fetch('/api/content?mode=post', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              author: Alpine
                .store('auth')
                .user
                .email,
              content: null,
              relatedId: this.postId
            })
          })
            .then((response) => response.json())
            .then((message) => {
              if (!message.success) {
                this
                  .notifications
                  .push({show: true, success: false, title: 'Message not posted', description: 'There was an error posting this message.'})
              } else {
                this
                  .notifications
                  .push({show: true, success: true, title: 'Message posted!', description: 'It can now appear in the feed.'})
                this.refreshFeed();
              }
            })
            .catch((error) => {
              this
                .notifications
                .push({show: true, success: false, title: 'Message not posted', description: 'There was an error posting this message.'})
            })
            . finally(() => {
              this.showNotifications = true
            })
        }
      }
    }
  </script>

{% endblock %}